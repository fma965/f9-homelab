---
apiVersion: v1
kind: Service
metadata:
  name: homeassistant-external
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 8123
---
apiVersion: discovery.k8s.io/v1
kind: EndpointSlice
metadata:
  name: homeassistant-external
  labels:
    kubernetes.io/service-name: homeassistant-external
addressType: IPv4
endpoints:
  - addresses:
      - 10.10.10.2
ports:
  - name: http
    protocol: TCP
    port: 8123
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: homeassistant
spec:
  parentRefs:
    - name: envoy-external
      namespace: network
      sectionName: https
  hostnames:
    - "home.${SECRET_DOMAIN}"
  rules:
    - backendRefs:
        - name: homeassistant-external
          port: 8123

---
apiVersion: v1
kind: Service
metadata:
  name: truenas-external
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 80
---
apiVersion: discovery.k8s.io/v1
kind: EndpointSlice
metadata:
  name: truenas-external
  labels:
    kubernetes.io/service-name: truenas-external
addressType: FQDN # Corrected: Added addressType for the FQDN
endpoints:
  - addresses:
      - f9-nas.internal
ports:
  - name: http
    protocol: TCP
    port: 80
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: truenas
spec:
  parentRefs:
    - name: envoy-external
      namespace: network
      sectionName: https
  hostnames:
    - "truenas.${SECRET_DOMAIN}"
  rules:
    - backendRefs:
        - name: truenas-external
          port: 80
---
# yaml-language-server: $schema=https://schemas.budimanjojo.com/gateway.envoyproxy.io/securitypolicy_v1alpha1.json
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  name: truenas
spec:
  extAuth:
    headersToExtAuth:
      - X-Forwarded-For # this is here so we can get the real IP
      - X-Forwarded-Proto
      - authorization
      - header-authorization
      - proxy-authorization
      - accept
      - cookie
    failOpen: false
    http:
      backendRefs:
        - group: ""
          kind: Service
          name: authelia
          namespace: default
          port: 80
      path: /api/authz/ext-authz/
      headersToBackend:
        - 'remote-*'
        - 'authelia-*'
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: truenas
---
apiVersion: v1
kind: Service
metadata:
  name: adguardhome-external
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 8080
---
apiVersion: discovery.k8s.io/v1
kind: EndpointSlice
metadata:
  name: adguardhome-external
  labels:
    kubernetes.io/service-name: adguardhome-external
addressType: IPv4
endpoints:
  - addresses:
      - 10.10.10.254
ports:
  - name: http
    protocol: TCP
    port: 8080
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: adguardhome
spec:
  parentRefs:
    - name: envoy-external
      namespace: network
      sectionName: https
  hostnames:
    - "adguard.${SECRET_DOMAIN}"
  rules:
    - backendRefs:
        - name: adguardhome-external
          port: 8080
---
# yaml-language-server: $schema=https://schemas.budimanjojo.com/gateway.envoyproxy.io/securitypolicy_v1alpha1.json
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  name: adguardhome
spec:
  extAuth:
    headersToExtAuth:
      - X-Forwarded-For # this is here so we can get the real IP
      - X-Forwarded-Proto
      - authorization
      - header-authorization
      - proxy-authorization
      - accept
      - cookie
    failOpen: false
    http:
      backendRefs:
        - group: ""
          kind: Service
          name: authelia
          namespace: default
          port: 80
      path: /api/authz/ext-authz/
      headersToBackend:
        - 'remote-*'
        - 'authelia-*'
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: adguardhome
---
apiVersion: v1
kind: Service
metadata:
  name: forgeui-external
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 7400
---
apiVersion: discovery.k8s.io/v1
kind: EndpointSlice
metadata:
  name: forgeui-external
  labels:
    kubernetes.io/service-name: forgeui-external
addressType: FQDN # Corrected: Added addressType for the FQDN
endpoints:
  - addresses:
      - f9-nas.internal
ports:
  - name: http
    protocol: TCP
    port: 7400
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: forgeui
spec:
  parentRefs:
    - name: envoy-external
      namespace: network
      sectionName: https
  hostnames:
    - "sd.${SECRET_DOMAIN}"
  rules:
    - backendRefs:
        - name: forgeui-external
          port: 7400

---
apiVersion: v1
kind: Service
metadata:
  name: remote-external
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 3000
---
apiVersion: discovery.k8s.io/v1
kind: EndpointSlice
metadata:
  name: remote-external
  labels:
    kubernetes.io/service-name: remote-external
addressType: IPv4
endpoints:
  - addresses:
      - 10.10.10.3
ports:
  - name: http
    protocol: TCP
    port: 3000
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: remote
spec:
  parentRefs:
    - name: envoy-external
      namespace: network
      sectionName: https
  hostnames:
    - "remote.${SECRET_DOMAIN}"
  rules:
    - backendRefs:
        - name: remote-external
          port: 3000
---
# yaml-language-server: $schema=https://schemas.budimanjojo.com/gateway.envoyproxy.io/securitypolicy_v1alpha1.json
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  name: remote
spec:
  extAuth:
    headersToExtAuth:
      - X-Forwarded-For # this is here so we can get the real IP
      - X-Forwarded-Proto
      - authorization
      - header-authorization
      - proxy-authorization
      - accept
      - cookie
    failOpen: false
    http:
      backendRefs:
        - group: ""
          kind: Service
          name: authelia
          namespace: default
          port: 80
      path: /api/authz/ext-authz/
      headersToBackend:
        - 'remote-*'
        - 'authelia-*'
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: remote
---
apiVersion: v1
kind: Service
metadata:
  name: nanokvm-external
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 80
---
apiVersion: discovery.k8s.io/v1
kind: EndpointSlice
metadata:
  name: nanokvm-external
  labels:
    kubernetes.io/service-name: nanokvm-external
addressType: IPv4
endpoints:
  - addresses:
      - 10.10.30.10
ports:
  - name: http
    protocol: TCP
    port: 80
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: nanokvm
spec:
  parentRefs:
    - name: envoy-external
      namespace: network
      sectionName: https
  hostnames:
    - "kvm.${SECRET_DOMAIN}"
  rules:
    - backendRefs:
        - name: nanokvm-external
          port: 80
---
# yaml-language-server: $schema=https://schemas.budimanjojo.com/gateway.envoyproxy.io/securitypolicy_v1alpha1.json
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  name: nanokvm
spec:
  extAuth:
    headersToExtAuth:
      - X-Forwarded-For # this is here so we can get the real IP
      - X-Forwarded-Proto
      - authorization
      - header-authorization
      - proxy-authorization
      - accept
      - cookie
    failOpen: false
    http:
      backendRefs:
        - group: ""
          kind: Service
          name: authelia
          namespace: default
          port: 80
      path: /api/authz/ext-authz/
      headersToBackend:
        - 'remote-*'
        - 'authelia-*'
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: nanokvm
---
apiVersion: v1
kind: Service
metadata:
  name: doco-cd-external
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 6584
---
apiVersion: discovery.k8s.io/v1
kind: EndpointSlice
metadata:
  name: doco-cd-external
  labels:
    kubernetes.io/service-name: doco-cd-external
addressType: IPv4
endpoints:
  - addresses:
      - 10.10.10.3
ports:
  - name: http
    protocol: TCP
    port: 6584
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: doco-cd
  annotations:
    gatus.home-operations.com/endpoint: |-
      url: "https://doco-cd.${SECRET_DOMAIN}/api/v1/status"
spec:
  hostnames:
    - "doco-cd.${SECRET_DOMAIN}"
  parentRefs:
    - name: envoy-external
      namespace: network
      sectionName: https
  rules:
    - backendRefs:
        - name: doco-cd-external
          port: 6584