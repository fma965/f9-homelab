---
log:
  level: info

authentication_backend:
  ldap:
    address: ldap://lldap.default.svc.cluster.local:389
    implementation: custom
    timeout: 5s
    start_tls: false
    base_dn: dc=f9,dc=casa
    additional_users_dn: ou=people
    users_filter: (&({username_attribute}={input})(objectClass=person))
    additional_groups_dn: ou=groups
    groups_filter: (member={dn})
    user: uid=admin,ou=people,dc=f9,dc=casa
    attributes:
      username: uid
      display_name: displayName
      group_name: cn
      mail: mail
      member_of: memberOf
  password_reset:
    disable: true
  refresh_interval: 1m

regulation:
  max_retries: 3
  find_time: 1h
  ban_time: 1d

session:
  name: authelia-home-lab
  inactivity: 3d
  expiration: 7d
  remember_me: 6M
  cookies:
    - name: authelia_session
      domain: ${SECRET_EXTERNAL_DOMAIN}
      authelia_url: https://auth.${SECRET_EXTERNAL_DOMAIN}
      default_redirection_url: https://${SECRET_EXTERNAL_DOMAIN}
  redis:
    host: dragonfly.database.svc.cluster.local
    port: 6379
    database_index: 2

access_control:
  default_policy: two_factor
  networks:
    - name: internal
      networks:
        - 10.0.0.0/8
        - 172.16.0.0/12
        - 192.168.0.0/16

    - name: cluster
      networks:
        - 10.42.0.0/16
  rules:
    - domain:
        - sonarr.${SECRET_EXTERNAL_DOMAIN}
        - radarr.${SECRET_EXTERNAL_DOMAIN}
        - prowlarr.${SECRET_EXTERNAL_DOMAIN}
        - sabnzbd.${SECRET_EXTERNAL_DOMAIN}
      resources: ["^/api.*$"]
      policy: bypass

    - domain:
        - "*.${SECRET_EXTERNAL_DOMAIN}"
      policy: bypass
      networks:
        - cluster

    - domain:
        - sonarr.${SECRET_EXTERNAL_DOMAIN}
        - radarr.${SECRET_EXTERNAL_DOMAIN}
        - prowlarr.${SECRET_EXTERNAL_DOMAIN}
        - sabnzbd.${SECRET_EXTERNAL_DOMAIN}
        - torrents.${SECRET_EXTERNAL_DOMAIN}
        - recommendarr.${SECRET_EXTERNAL_DOMAIN}
        - docs.${SECRET_EXTERNAL_DOMAIN}
      subject:
        - "group:media"
      policy: one_factor

    - domain:
        - zigbee.${SECRET_EXTERNAL_DOMAIN}
        - cctv.${SECRET_EXTERNAL_DOMAIN}
        - home.${SECRET_EXTERNAL_DOMAIN}
      subject:
        - "group:home"
      policy: two_factor

    - domain:
        - "*.${SECRET_EXTERNAL_DOMAIN}"
      subject:
        - "group:admin"
      policy: two_factor

    - domain:
        - "*.${SECRET_EXTERNAL_DOMAIN}"
      policy: deny

notifier:
  disable_startup_check: true
  smtp:
    address: smtp-relay.network.svc.cluster.local:25
    disable_require_tls: true

identity_validation:
  reset_password:
    jwt_secret: '{{ env "JWT_SECRET" }}'

identity_providers:
  oidc:
    cors:
      endpoints:
        - authorization
        - token
        - revocation
        - introspection
      allowed_origins_from_client_redirect_uris: true
    claims_policies:
      ## Creates the 'default' claims policy.
      default:
        id_token: ['groups', 'email', 'email_verified', 'alt_emails', 'preferred_username', 'name']

    jwks:
      - key_id: default
        key: {{ env "JWKS_KEY" | mindent 10 "|" | msquote }}

    clients:
      - client_name: 'immich'
        client_id: '{{ env "IMMICH_OAUTH_CLIENT_ID" }}'
        client_secret: '{{ env "IMMICH_OAUTH_CLIENT_SECRET" }}'
        public: false
        authorization_policy: 'two_factor'
        require_pkce: false
        pkce_challenge_method: ''
        redirect_uris:
          - 'https://photos.${SECRET_EXTERNAL_DOMAIN}/auth/login'
          - 'https://photos.${SECRET_EXTERNAL_DOMAIN}/user-settings'
          - 'app.immich:///oauth-callback'
        scopes:
          - 'openid'
          - 'profile'
          - 'email'
        response_types:
          - 'code'
        grant_types:
          - 'authorization_code'
        access_token_signed_response_alg: 'none'
        userinfo_signed_response_alg: 'none'
        token_endpoint_auth_method: 'client_secret_post'

      - client_name: 'Forgejo'
        client_id: '{{ env "FORGEJO_OAUTH_CLIENT_ID" }}'
        client_secret: '{{ env "FORGEJO_OAUTH_CLIENT_SECRET" }}'
        public: false
        authorization_policy: 'two_factor'
        require_pkce: true
        pkce_challenge_method: 'S256'
        redirect_uris:
          - 'https://git.${SECRET_EXTERNAL_DOMAIN}/user/oauth2/F9/callback'
          - 'https://git.${SECRET_EXTERNAL_DOMAIN}/user/oauth2/authelia/callback'
        scopes:
          - 'openid'
          - 'email'
          - 'profile'
          - 'groups'
        response_types:
          - 'code'
        grant_types:
          - 'authorization_code'
        access_token_signed_response_alg: 'none'
        userinfo_signed_response_alg: 'none'
        token_endpoint_auth_method: 'client_secret_basic'

      - client_name: Directus
        client_id: '{{ env "DIRECTUS_OAUTH_CLIENT_ID" }}'
        client_secret: '{{ env "DIRECTUS_OAUTH_CLIENT_SECRET" }}'
        public: false
        authorization_policy: two_factor
        pre_configured_consent_duration: 1y
        scopes:
          - openid
          - profile
          - email
        redirect_uris:
          - https://gamesdb.${SECRET_EXTERNAL_DOMAIN}/auth/login/authentik/callback
        userinfo_signed_response_alg: none
        claims_policy: default
        token_endpoint_auth_method: 'client_secret_basic'

      - client_name: 'Open WebUI'
        client_id: '{{ env "OPENWEBUI_OAUTH_CLIENT_ID" }}'
        client_secret: '{{ env "OPENWEBUI_OAUTH_CLIENT_SECRET" }}'
        public: false
        authorization_policy: 'two_factor'
        require_pkce: false
        pkce_challenge_method: ''
        redirect_uris:
          - 'https://chat.${SECRET_EXTERNAL_DOMAIN}/oauth/oidc/callback'
        scopes:
          - 'openid'
          - 'profile'
          - 'groups'
          - 'email'
        response_types:
          - 'code'
        grant_types:
          - 'authorization_code'
        access_token_signed_response_alg: 'none'
        userinfo_signed_response_alg: 'none'
        token_endpoint_auth_method: 'client_secret_basic'

      - client_name: 'Outline'
        client_id: '{{ env "OUTLINE_OAUTH_CLIENT_ID" }}'
        client_secret: '{{ env "OUTLINE_OAUTH_CLIENT_SECRET" }}'
        public: false
        authorization_policy: 'two_factor'
        require_pkce: false
        pkce_challenge_method: ''
        redirect_uris:
          - 'https://docs.${SECRET_EXTERNAL_DOMAIN}/auth/oidc.callback'
        scopes:
          - 'openid'
          - 'offline_access'
          - 'profile'
          - 'email'
        response_types:
          - 'code'
        grant_types:
          - 'authorization_code'
          - 'refresh_token'
        access_token_signed_response_alg: 'none'
        userinfo_signed_response_alg: 'none'
        token_endpoint_auth_method: 'client_secret_post'

      - client_name: 'Zipline'
        client_id: '{{ env "ZIPLINE_OAUTH_CLIENT_ID" }}'
        client_secret: '{{ env "ZIPLINE_OAUTH_CLIENT_SECRET" }}'
        public: false
        require_pkce: false
        pkce_challenge_method: ''
        redirect_uris:
          - 'https://i.${SECRET_EXTERNAL_DOMAIN}/api/auth/oauth/oidc'
        scopes:
          - 'openid'
          - 'offline_access'
          - 'email'
          - 'profile'
        response_types:
          - 'code'
        grant_types:
          - 'refresh_token'
          - 'authorization_code'
        access_token_signed_response_alg: 'none'
        userinfo_signed_response_alg: 'none'
        token_endpoint_auth_method: 'client_secret_post'
