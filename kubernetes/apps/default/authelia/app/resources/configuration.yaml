---
log:
  level: info

authentication_backend:
  ldap:
    address: ldap://lldap.default.svc.cluster.local:389
    implementation: custom
    timeout: 5s
    start_tls: false
    base_dn: dc=f9,dc=casa
    additional_users_dn: ou=people
    users_filter: (&({username_attribute}={input})(objectClass=person))
    additional_groups_dn: ou=groups
    groups_filter: (member={dn})
    user: uid=admin,ou=people,dc=f9,dc=casa
    attributes:
      username: uid
      display_name: displayName
      group_name: cn
      mail: mail
      member_of: memberOf
  password_reset:
    disable: true
  refresh_interval: 1m

regulation:
  max_retries: 3
  find_time: 1h
  ban_time: 1d

session:
  name: authelia-home-lab
  inactivity: 3d
  expiration: 7d
  remember_me: 6M
  cookies:
    - domain: f9.casa
      authelia_url: https://auth.f9.casa
  redis:
    host: redis.redis.default.svc.cluster.local
    password: {{ env "REDIS_PASSWORD" }}

access_control:
  default_policy: two_factor
  networks:
    - name: internal
      networks:
        - 10.0.0.0/8
        - 172.16.0.0/12
        - 192.168.0.0/16
  rules:
    - domain:
        - sonarr.f9.casa
        - radarr.f9.casa
        - prowlarr.f9.casa
        - sabnzbd.f9.casa
      resources: ["^/api.*$"]
      policy: bypass

    # Bypass domains that have their own auth or don't need auth
    - domain:
        - auth.f9.casa
        - lldap.f9.casa

        - api.f9.casa
        - debtmanager.f9.casa
        - docs.f9.casa
        - echo.f9.casa
        - flux-webhook.f9.casa
        - games.f9.casa
        - gamesdb.f9.casa
        - gameservers.f9.casa
        - git.f9.casa
        - home.f9.casa
        - hv1.f9.casa
        - hv2.f9.casa
        - hv3.f9.casa
        - jellyfin.f9.casa
        - komodo.f9.casa
        - ollama.f9.casa
        - overlays.f9.casa
        - paperless.f9.casa
        - photos.f9.casa
        - plex.f9.casa
        - remote.f9.casa
        - s3.f9.casa
        - status.f9.casa
        - sync.f9.casa
        - *.gameservers.f9.casa
      policy: bypass

    - domain:
        - sonarr.f9.casa
        - radarr.f9.casa
        - prowlarr.f9.casa
        - sabnzbd.f9.casa
        - torrents.f9.casa
      subject:
        - "group:media"
      policy: one_factor

    - domain: "*.f9.casa"
      subject:
        - "group:admin"
      policy: two_factor

    - domain: "*.f9.casa"
      policy: deny

notifier:
  smtp:
    sender: "Authelia <auth@f9.casa>"

identity_validation:
  reset_password:
    jwt_secret: '{{ env "JWT_SECRET" }}'

identity_providers:
  oidc:
    cors:
      endpoints:
        - authorization
        - token
        - revocation
        - introspection
      allowed_origins_from_client_redirect_uris: true
    claims_policies:
      ## Creates the 'default' claims policy.
      default:
        id_token: ['groups', 'email', 'email_verified', 'alt_emails', 'preferred_username', 'name']

    jwks:
      - key_id: default
        key: {{ env "JWKS_KEY" | mindent 10 "|" | msquote }}

    clients:
      - client_name: 'immich'
        client_id: '{{ env "IMMICH_OAUTH_CLIENT_ID" }}'
        client_secret: '{{ env "IMMICH_OAUTH_CLIENT_SECRET" }}'
        public: false
        authorization_policy: 'two_factor'
        require_pkce: false
        pkce_challenge_method: ''
        redirect_uris:
          - 'https://photos.f9.casa/auth/login'
          - 'https://photos.f9.casa/user-settings'
          - 'app.immich:///oauth-callback'
        scopes:
          - 'openid'
          - 'profile'
          - 'email'
        response_types:
          - 'code'
        grant_types:
          - 'authorization_code'
        access_token_signed_response_alg: 'none'
        userinfo_signed_response_alg: 'none'
        token_endpoint_auth_method: 'client_secret_post'

      - client_name: 'Forgejo'
        client_id: '{{ env "FORGEJO_OAUTH_CLIENT_ID" }}'
        client_secret: '{{ env "FORGEJO_OAUTH_CLIENT_SECRET" }}'
        public: false
        authorization_policy: 'two_factor'
        require_pkce: true
        pkce_challenge_method: 'S256'
        redirect_uris:
          - 'https://git.f9.casa/user/oauth2/F9/callback'
          - 'https://git.f9.casa/user/oauth2/authelia/callback'
        scopes:
          - 'openid'
          - 'email'
          - 'profile'
          - 'groups'
        response_types:
          - 'code'
        grant_types:
          - 'authorization_code'
        access_token_signed_response_alg: 'none'
        userinfo_signed_response_alg: 'none'
        token_endpoint_auth_method: 'client_secret_basic'

      - client_name: Directus
        client_id: '{{ env "DIRECTUS_OAUTH_CLIENT_ID" }}'
        client_secret: '{{ env "DIRECTUS_OAUTH_CLIENT_SECRET" }}'
        public: false
        authorization_policy: two_factor
        pre_configured_consent_duration: 1y
        scopes:
          - openid
          - profile
          - email
        redirect_uris:
          - https://gamesdb.f9.casa/auth/login/authentik/callback
        userinfo_signed_response_alg: none
        claims_policy: default
        token_endpoint_auth_method: 'client_secret_basic'

      - client_name: 'Komodo'
        client_id: '{{ env "KOMODO_OAUTH_CLIENT_ID" }}'
        client_secret: '{{ env "KOMODO_OAUTH_CLIENT_SECRET" }}'
        public: false
        require_pkce: true
        pkce_challenge_method: 'S256'
        authorization_policy: 'two_factor'
        redirect_uris:
          - 'https://komodo.f9.casa/auth/oidc/callback'
        scopes:
          - 'openid'
          - 'profile'
          - 'email'
        response_types:
          - 'code'
        grant_types:
          - 'authorization_code'
        access_token_signed_response_alg: 'none'
        userinfo_signed_response_alg: 'none'
        token_endpoint_auth_method: 'client_secret_basic'

      - client_name: 'Open WebUI'
        client_id: '{{ env "OPENWEBUI_OAUTH_CLIENT_ID" }}'
        client_secret: '{{ env "OPENWEBUI_OAUTH_CLIENT_SECRET" }}'
        public: false
        authorization_policy: 'two_factor'
        require_pkce: false
        pkce_challenge_method: ''
        redirect_uris:
          - 'https://chat.f9.casa/oauth/oidc/callback'
        scopes:
          - 'openid'
          - 'profile'
          - 'groups'
          - 'email'
        response_types:
          - 'code'
        grant_types:
          - 'authorization_code'
        access_token_signed_response_alg: 'none'
        userinfo_signed_response_alg: 'none'
        token_endpoint_auth_method: 'client_secret_basic'

      - client_name: 'Outline'
        client_id: '{{ env "OUTLINE_OAUTH_CLIENT_ID" }}'
        client_secret: '{{ env "OUTLINE_OAUTH_CLIENT_SECRET" }}'
        public: false
        authorization_policy: 'two_factor'
        require_pkce: false
        pkce_challenge_method: ''
        redirect_uris:
          - 'https://docs.f9.casa/auth/oidc.callback'
        scopes:
          - 'openid'
          - 'offline_access'
          - 'profile'
          - 'email'
        response_types:
          - 'code'
        grant_types:
          - 'authorization_code'
          - 'refresh_token'
        access_token_signed_response_alg: 'none'
        userinfo_signed_response_alg: 'none'
        token_endpoint_auth_method: 'client_secret_post'

      - client_name: 'Zipline'
        client_id: '{{ env "ZIPLINE_OAUTH_CLIENT_ID" }}'
        client_secret: '{{ env "ZIPLINE_OAUTH_CLIENT_SECRET" }}'
        public: false
        require_pkce: false
        pkce_challenge_method: ''
        redirect_uris:
          - 'https://i.f9.casa/api/auth/oauth/oidc'
        scopes:
          - 'openid'
          - 'offline_access'
          - 'email'
          - 'profile'
        response_types:
          - 'code'
        grant_types:
          - 'refresh_token'
          - 'authorization_code'
        access_token_signed_response_alg: 'none'
        userinfo_signed_response_alg: 'none'
        token_endpoint_auth_method: 'client_secret_basic'

      - client_name: 'Proxmox'
        client_id: '{{ env "PROXMOX_OAUTH_CLIENT_ID" }}'
        client_secret: '{{ env "PROXMOX_OAUTH_CLIENT_SECRET" }}'
        public: false
        authorization_policy: 'two_factor'
        require_pkce: true
        pkce_challenge_method: 'S256'
        redirect_uris:
          - https://10.0.40.1:8006
          - https://10.0.40.2:8006
          - https://10.0.40.3:8006
          - https://f9-hv1.internal:8006
          - https://f9-hv2.internal:8006
          - https://f9-hv3.internal:8006
          - https://pbs.f9.casa:8007
          - https://pbs.f9.casa
          - https://hv1.f9.casa
          - https://hv2.f9.casa
          - https://hv3.f9.casa
        scopes:
          - 'openid'
          - 'profile'
          - 'email'
          - 'groups'
        response_types:
          - 'code'
        grant_types:
          - 'authorization_code'
        access_token_signed_response_alg: 'none'
        userinfo_signed_response_alg: 'none'
        token_endpoint_auth_method: 'client_secret_basic'