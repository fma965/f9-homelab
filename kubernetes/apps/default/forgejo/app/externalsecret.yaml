---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/external-secrets.io/externalsecret_v1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: forgejo
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword
  target:
    name: forgejo-secret
    template:
      data:

        # overall
        FORGEJO__APP_NAME: "Homelab Git"
        FORGEJO__APP_SLOGAN: "For when you need a local git server"

        # server
        FORGEJO__server__ROOT_URL: "https://git.${SECRET_DOMAIN}"
        FORGEJO__server__APP_DATA_PATH: "/data/gitea"
        FORGEJO__server__SSH_PORT: "2222"
        # database
        FORGEJO__database__DB_TYPE: "postgres"
        FORGEJO__database__HOST: &dbhost "postgres-rw.database.svc.cluster.local"
        FORGEJO__database__USER: &dbuser forgejo
        FORGEJO__database__PASSWD: &dbpass "{{ .FORGEJO_DB_PASSWORD }}"
        FORGEJO__database__NAME: &dbname forgejo

        # security
        FORGEJO__security__SECRET_KEY: "{{ .FORGEJO_ENCRYPTION_KEY }}"
        FORGEJO__security__MIN_PASSWORD_LENGTH: "12"
        FORGEJO__security__PASSWORD_COMPLEXITY: "lower,upper,digit"


        FORGEJO__cache__ENABLED: "true"
        FORGEJO__cache__ADAPTER: "redis"
        FORGEJO__cache__HOST: "redis://:${REDIS_PASSWORD}@redis.redis.svc.cluster.local:6379"
        FORGEJO__database__DB_TYPE: "postgres"
        FORGEJO__federation__ENABLED: "false"
        FORGEJO__git.timeout__MIGRATE: "3000"
        FORGEJO__git.timeout__MIRROR: "3000"

        # mailer
        FORGEJO__mailer__ENABLED: "true"
        FORGEJO__mailer__PROTOCOL: "smtp"
        FORGEJO__mailer__SMTP_ADDR: "smtp-relay.network.svc.cluster.local"
        FORGEJO__mailer__SMTP_PORT: "25"
        FORGEJO__mailer__FROM: "git@${SECRET_DOMAIN}"

        # repository
        FORGEJO__repository__DEFAULT_PRIVATE: "true"
        FORGEJO__repository__DEFAULT_REPO_UNITS: "repo.code,repo.releases,repo.issues,repo.pulls,repo.packages"
        FORGEJO__repository__DEFAULT_PUSH_CREATE_PRIVATE: "true"
        FORGEJO__repository__ENABLE_PUSH_CREATE_USER: "true"
        FORGEJO__repository__ENABLE_PUSH_CREATE_ORG: "true"

        # ser


        FORGEJO__service__DISABLE_REGISTRATION: "true"
        FORGEJO__service__ENABLE_NOTIFY_MAIL: "true"
        FORGEJO__service__REQUIRE_SIGNIN_VIEW: "false"
        FORGEJO__ui__DEFAULT_SHOW_FULL_NAME: "true"
        FORGEJO__ui__DEFAULT_THEME: "gitea-dark"

        # Postgres Init
        INIT_POSTGRES_DBNAME: *dbname
        INIT_POSTGRES_HOST: *dbhost
        INIT_POSTGRES_USER: *dbuser
        INIT_POSTGRES_PASS: *dbpass
        INIT_POSTGRES_SUPER_PASS: "{{ .POSTGRES_SUPER_PASS }}"
  dataFrom:
    - extract:
        key: forgejo
    - extract:
        key: cloudnative-pg