name: Unecrypted Secret Check
on: [push, pull_request]

jobs:
  pre-commit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Set up pre-commit
        run: |
          pip install pre-commit
          pre-commit install-hooks

      - name: Check for unencrypted secrets
        run: |
          error_count=0
          while IFS= read -r -d '' file; do
            if [[ "$file" == *.env ]]; then
              # Docker .env format check (SOPS adds these headers)
              if ! grep -q -e '^sops_' -e '^# created-by: sops' "$file"; then
                echo "::warning file=$file::Unencrypted Docker secret"
                ((error_count++))
              fi
            else
              # YAML/JSON/TFVars check
              if ! grep -q -e '"sops":' -e '^sops:' "$file"; then
                echo "::warning file=$file::Unencrypted secret"
                ((error_count++))
              fi
            fi
          done < <(find . \( \
            -path "./kubernetes/*" \( -name "*secret.y*ml" -o -name "*secret.sops.y*ml" \) -o \
            -path "./infrastructure/*" -name "*.auto.*tfvars" -o \
            -path "./docker/*" \( -name "*secret.env" -o -name "*secret.sops.env" \) \
          \) -type f -print0)

          if [ "$error_count" -gt 0 ]; then
            echo "::error::Found $error_count unencrypted secrets"
            exit 1
          fi