name: Unecrypted Secret Check
on: [push, pull_request]

jobs:
  check-secrets:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for git diff

      - name: Check for unencrypted secrets
        run: |
          # Get changed files matching secret patterns (excluding .sops.yaml)
          files=$(git diff --name-only HEAD^ HEAD | grep '\.sops\.' | grep -v '\.sops\.yaml$')

          # Verify encryption
          unencrypted_files=()
          for file in $files; do
            if [ -f "$file" ] && ! grep -q -e 'sops_' -e 'created-by: sops' -e '"sops":' -e 'sops:' "$file"; then
              echo "::warning file=$file::Potentially unencrypted secret file detected: $file"
              unencrypted_files+=("$file")
            fi
          done

          if [ ${#unencrypted_files[@]} -ne 0 ]; then
            count=${#unencrypted_files[@]}
            echo "::error::Found $count unencrypted secret file(s)"
            exit 1
          else
            echo "::notice::All *.sops.* files appear to be properly encrypted"
            exit 0
          fi