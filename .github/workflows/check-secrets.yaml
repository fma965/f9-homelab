name: Unecrypted Secret Check
on: [push, pull_request]

jobs:
  check-secrets:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for git diff


      - name: Check for unencrypted secrets
        run: |
          # Get changed files matching secret patterns
          files=$(git diff --name-only HEAD^ HEAD | grep '\.sops\.')

          # Verify encryption
          unencrypted_files=()
          for file in $files; do
            if [ -f "$file" ] && ! grep -q -e 'sops_' -e 'created-by: sops' -e '"sops":' -e 'sops:' "$file"; then
              echo "::warning file=$file::Potentially unencrypted .sops file detected: $file"
              unencrypted_files+=("$file")
            fi
          done

          if [ ${#unencrypted_files[@]} -ne 0 ]; then
            echo "❌ Files with '.sops.' in name but without encryption markers:" >&2
            printf '%s\n' "${unencrypted_files[@]}" >&2
            echo "These files should be properly encrypted with SOPS" >&2
            exit 1
          fi